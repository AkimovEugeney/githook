#!/bin/bash
set -e

    # –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "üí° –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $BRANCH"


# –°–ø–∏—Å–æ–∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –≤–µ—Ç–æ–∫ (–¥–æ–±–∞–≤—å —Å—é–¥–∞ –Ω—É–∂–Ω—ã–µ)
PROTECTED_BRANCHES=("stage" "prod" "main")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞ –∑–∞—â–∏—â—ë–Ω–Ω–æ–π
for PROTECTED in "${PROTECTED_BRANCHES[@]}"; do
    if [[ "$BRANCH" == "$PROTECTED" ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –í–µ—Ç–∫–∞ $BRANCH –∑–∞—â–∏—â–µ–Ω–∞! –ü—Ä—è–º–æ–π push –∑–∞–ø—Ä–µ—â—ë–Ω."
        echo "üîí –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ Merge Requests."
        exit 1
    fi
done

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–º–º–∏—Ç–∞—Ö –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º push
remote="$1"
url="$2"

zero=$(git hash-object --stdin </dev/null | tr '[0-9a-f]' '0')

while read local_ref local_oid remote_ref remote_oid
do
    if test "$local_oid" = "$zero"
    then
        # Handle delete
        :
    else
        if test "$remote_oid" = "$zero"
        then
            # New branch, examine all commits
            range="$local_oid"
        else
            # Update to existing branch, examine new commits
            range="$remote_oid..$local_oid"
        fi

        # Check for WIP commit
        commit=$(git rev-list -n 1 --grep '^WIP' "$range")
        if test -n "$commit"
        then
            echo >&2 "–ù–∞–π–¥–µ–Ω WIP –∫–æ–º–º–∏—Ç –≤ $local_ref, –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º push"
            exit 1
        fi
    fi
done

exit 0